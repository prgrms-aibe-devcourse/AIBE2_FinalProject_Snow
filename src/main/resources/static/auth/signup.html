<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>

    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 50px auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .error { color: red; font-size: 14px; margin-top: 5px; }
        .success { color: green; }

        /* 관심사 선택 스타일 */
        .interest-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .interest-item {
            position: relative;
        }
        .interest-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: auto;
        }
        .interest-item label {
            display: inline-block;
            padding: 6px 12px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: normal;
            margin: 0;
        }
        .interest-item input[type="checkbox"]:checked + label {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
<h2>회원가입</h2>
<form action="/users/new" method="post">
    <div class="form-group">
        <label>이메일 *</label>
        <input type="email" id="email" name="email" placeholder="이메일을 입력하세요"/>
        <div id="email-error" class="error-message" style="display: none; color: red; font-size: 14px; margin-top: 5px;"></div>
    </div>
    <div class="form-group">
        <label>비밀번호 *</label>
        <input type="password" name="password" placeholder="8-16자 비밀번호"/>
    </div>
    <div class="form-group">
        <label>이름 *</label>
        <input type="text" name="name" placeholder="이름을 입력하세요"/>
    </div>
    <div class="form-group">
        <label>닉네임</label>
        <input type="text" name="nickname" placeholder="닉네임을 입력하세요"/>
    </div>
    <div class="form-group">
        <label>전화번호</label>
        <input type="text" name="phone" placeholder="전화번호를 입력하세요"/>

        <label style="margin-top: 15px;">관심사 골라보기</label>
        <div class="interest-tags">
            <div class="interest-item">
                <input type="checkbox" id="fashion" name="interests" value="패션">
                <label for="fashion">패션</label>
            </div>
            <div class="interest-item">
                <input type="checkbox" id="pets" name="interests" value="반려동물">
                <label for="pets">반려동물</label>
            </div>
            <div class="interest-item">
                <input type="checkbox" id="game" name="interests" value="게임">
                <label for="game">게임</label>
            </div>
            <div class="interest-item">
                <input type="checkbox" id="culture" name="interests" value="문화/컨텐츠">
                <label for="culture">문화/컨텐츠</label>
            </div>
            <div class="interest-item">
                <input type="checkbox" id="history" name="interests" value="역사">
                <label for="history">역사</label>
            </div>
            <div class="interest-item">
                <input type="checkbox" id="sports" name="interests" value="레저/스포츠">
                <label for="sports">레저/스포츠</label>
            </div>
        </div>
    </div>
    <button type="submit">가입하기</button>
</form>
<p style="margin-top: 20px;">
    이미 계정이 있으신가요? <a href="/users/login">로그인하기</a>
</p>
<script>
    // 회원가입 폼 처리 스크립트
    document.addEventListener('DOMContentLoaded', function() {
        const signupForm = document.querySelector('form');

        if (signupForm) {
            signupForm.addEventListener('submit', handleSignup);
        }
    });

    async function handleSignup(event) {
        event.preventDefault(); // 기본 폼 제출 방지

        const form = event.target;
        const formData = new FormData(form);

        // 기본 사용자 정보 수집
        const userData = {
            email: formData.get('email'),
            password: formData.get('password'),
            name: formData.get('name'),
            nickname: formData.get('nickname') || null,
            phone: formData.get('phone') || null
        };

        // 관심사 정보 수집 (체크된 항목들을 category_id로 변환)
        const selectedInterests = formData.getAll('interests');
        const interests = mapInterestsToCategoryIds(selectedInterests);

        // 유효성 검사
        if (!validateUserData(userData)) {
            return;
        }

        try {
            // 회원가입 API 호출
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user: userData,
                    interests: interests
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert('회원가입이 완료되었습니다!');
                // 로그인 페이지로 리다이렉트
                window.location.href = '/users/login';
            } else {
                alert(result.message || '회원가입 중 오류가 발생했습니다.');
            }
        } catch (error) {
            console.error('회원가입 오류:', error);
            alert('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
        }
    }

    function validateUserData(userData) {
        // 필수 필드 검사
        if (!userData.email) {
            alert('이메일을 입력해주세요.');
            return false;
        }

        if (!userData.password) {
            alert('비밀번호를 입력해주세요.');
            return false;
        }

        if (!userData.name) {
            alert('이름을 입력해주세요.');
            return false;
        }

        // 이메일 형식 검사
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(userData.email)) {
            alert('올바른 이메일 형식을 입력해주세요.');
            return false;
        }

        // 비밀번호 길이 검사
        if (userData.password.length < 8 || userData.password.length > 16) {
            alert('비밀번호는 8-16자로 입력해주세요.');
            return false;
        }

        return true;
    }

    // 관심사 문자열을 category_id로 매핑하는 함수
    function mapInterestsToCategoryIds(interests) {
        const categoryMap = {
            '패션': 1,
            '반려동물': 2,
            '게임': 3,
            '문화/컨텐츠': 4,
            '역사': 5,
            '레저/스포츠': 6
        };

        return interests.map(interest => categoryMap[interest]).filter(id => id !== undefined);
    }

    // 실시간 이메일 검증 함수
    function validateEmailRealtime(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // 이메일 필드에 실시간 검증 이벤트
    document.addEventListener('DOMContentLoaded', function() {
        const emailInput = document.getElementById('email'); // 실제 이메일 input id로 변경
        const emailError = document.getElementById('email-error'); // 에러 메시지 표시할 요소

        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                const email = this.value.trim();

                if (email && !validateEmailRealtime(email)) {
                    emailError.textContent = '올바른 이메일 형식을 입력해주세요.';
                    emailError.style.display = 'block';
                    this.classList.add('error');
                } else {
                    emailError.textContent = '';
                    emailError.style.display = 'none';
                    this.classList.remove('error');
                }
            });
        }
    });

    async function checkEmailDuplicate(email) {
        try {
            const response = await fetch(`/api/users/check-email?email=${encodeURIComponent(email)}`);
            const data = await response.json();
            return data.exists;
        } catch (error) {
            console.error('이메일 중복 확인 오류:', error);
            return false;
        }
    }

    // 이메일 필드에서 포커스를 벗어날 때 중복 확인
    document.getElementById('email').addEventListener('blur', async function() {
        const email = this.value;
        const errorElement = document.getElementById('email-error');

        // 1. 형식 검증
        if (!validateEmail(email)) {
            errorElement.textContent = '올바른 이메일 형식을 입력해주세요.';
            return;
        }

        // 2. 중복 확인
        const isDuplicate = await checkEmailDuplicate(email);
        if (isDuplicate) {
            errorElement.textContent = '이미 사용 중인 이메일입니다.';
            this.classList.add('error');
        } else {
            errorElement.textContent = '';
            this.classList.remove('error');
        }
    });

    async function checkEmailDuplicate(email) {
        try {
            const response = await fetch(`/api/auth/check-email?email=${encodeURIComponent(email)}`); // URL 수정
            const data = await response.json();
            return data.exists;
        } catch (error) {
            console.error('이메일 중복 확인 오류:', error);
            return false;
        }
    }

    function validateEmailRealtime(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // 이메일 필드에서 포커스를 벗어날 때 중복 확인 (기존 유지)
    document.getElementById('email').addEventListener('blur', async function() {
        const email = this.value.trim();
        const errorElement = document.getElementById('email-error');

        if (!email) {
            errorElement.textContent = '';
            this.classList.remove('error');
            return;
        }

        // 1. 형식 검증
        if (!validateEmailRealtime(email)) {
            errorElement.textContent = '올바른 이메일 형식을 입력해주세요.';
            this.classList.add('error');
            return;
        }

        // 2. 중복 확인
        const isDuplicate = await checkEmailDuplicate(email);
        if (isDuplicate) {
            errorElement.textContent = '이미 사용 중인 이메일입니다.';
            this.classList.add('error');
        } else {
            errorElement.textContent = '';
            this.classList.remove('error');
        }
    });

    // Debounce 추가 (타이핑 중 실시간 검증)
    let debounceTimer;

    function debounce(func, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(func, delay);
    }

    document.getElementById('email').addEventListener('input', function() {
        const email = this.value.trim();
        const errorElement = document.getElementById('email-error');

        if (!email) {
            errorElement.textContent = '';
            this.classList.remove('error');
            return;
        }

        debounce(async function() {
            // 1. 형식 검증
            if (!validateEmailRealtime(email)) {
                errorElement.textContent = '올바른 이메일 형식을 입력해주세요.';
                document.getElementById('email').classList.add('error');
                return;
            }

            // 2. 중복 확인
            const isDuplicate = await checkEmailDuplicate(email);
            if (isDuplicate) {
                errorElement.textContent = '이미 사용 중인 이메일입니다.';
                document.getElementById('email').classList.add('error');
            } else {
                errorElement.textContent = '';
                document.getElementById('email').classList.remove('error');
            }
        }, 500);
    });

</script>
</body>
</html>